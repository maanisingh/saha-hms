// schema.prisma
// HMS Pro - production-hardened: decimal precision, publicId, soft-delete, onDelete rules, indexes

// **************************************************************************************
// ‚úÖ UPDATE: Centralization of Common Fields (User Model as Single Source of Truth)
// Saare common fields (firstName, lastName, gender, dateOfBirth, phone, address)
// ko User model mein move kar diya gaya hai.
// Specialized models (Doctor, Patient, Nurse, Pharmacist) se yeh fields hata diye gaye hain.
// Staff models (Doctor, Nurse, Pharmacist) mein userId ko mandatory One-to-One rakha gaya hai.
// **************************************************************************************

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/// --------------------
/// Enums
/// --------------------
enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

// ‚ö†Ô∏è FIX: Renamed from 'Department' to resolve the P1012 conflict with the 'Department' model.
enum StaffDepartmentName {
  Doctors
  Nursing
  Administration
  Support_Staff
}

enum RadiologyStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum LabStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  PHARMACIST
  LAB_TECH
  RADIOLOGIST
  FINANCE
  HR
  PATIENT
  AUDITOR
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  IN_CONSULTATION
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum PaymentMode {
  CASH
  FIB
  CARD
  INSURANCE
  NEFT
  UPI
  OTHER
}

enum StockStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  CRITICAL // ‚úÖ Newly added¬†enum¬†value
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED
  FAILED
}

enum TestStatus {
  REQUESTED
  IN_PROCESS
  COMPLETED
  CANCELLED
  REVIEW_PENDING
}

enum ResultStatus {
  NORMAL
  ABNORMAL
  CRITICAL
  NOT_REPORTED
}

enum InvoiceType {
  CONSULTATION
  LAB
  RADIOLOGY
  PHARMACY
  PROCEDURE
  ADMISSION
  OTHER
}

enum DepartmentType {
  CLINICAL
  NON_CLINICAL
  SUPPORT
  ADMIN
}

enum CommissionType {
  PERCENTAGE
  FLAT
}

enum CommissionStatus {
  PENDING
  READY_TO_PAY
  PAID
  CANCELLED
}

enum SourceType {
  PHARMACY
  LAB
  RADIOLOGY
  PROCEDURE
  BLOOD_BANK
  CONSULTATION
  OTHER
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum ShiftType {
  DAY
  NIGHT
}

enum DutyShiftType {
  STRAIGHT
  BREAK_SHIFT
  ROTATIONAL
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum DutyStatus {
  SCHEDULED
  ON_LEAVE
  OFF_DUTY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  ON_LEAVE
}

enum FollowUpPurpose {
  REVIEW
  LAB_RESULT
  PROCEDURE
  FOLLOW_CHECKUP
}

enum FollowUpStatus {
  SCHEDULED
  COMPLETED
  MISSED
  CANCELLED
}

enum InsuranceClaimStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  SETTLED
}

enum RefundMode {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  CHEQUE
}

enum RefundReason {
  CANCELLED_APPOINTMENT
  BILLING_ERROR
  RETURNED_MEDICINE
  INSURANCE_ADJUSTMENT
  OTHER
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum AdmissionStatus {
  ADMITTED
  DISCHARGED
}

enum TaskType {
  CLEANING
  MAINTENANCE
  WASTE_DISPOSAL
  SANITIZATION
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum HousekeepingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  VERIFIED
}

enum PatientStatus {
  OPD
  IPD
  EMERGENCY
  DISCHARGE
  CANCELLED
}
enum MedicineStatus {
  IN_STOCK
  LOW_STOCK
  CRITICAL
  OUT_OF_STOCK
}


/// --------------------
/// Core System Models
/// --------------------

// === CENTRAL USER MODEL (LOGIN & COMMON FIELDS) ===
model User {
  id          Int       @id @default(autoincrement())
  publicId    String    @unique @default(uuid())
  email       String    @unique
  password    String
  role        UserRole
  firstName   String?
  lastName    String?
  displayName String?
  gender      Gender    @default(UNKNOWN)
  dateOfBirth DateTime?
  phone       String?   @unique
  address     String?
  locationTrack  LocationTracking?  //mukul

  // AUDIT AND STATUS FIELDS
  isActive    Boolean   @default(true)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById Int?
  updatedById Int?

  // SELF-RELATIONS (AUDIT)
  createdBy    User?  @relation("UserCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?  @relation("UserUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("UserCreatedBy")
  updatedUsers User[] @relation("UserUpdatedBy")

  // ONE-TO-ONE RELATIONS TO STAFF TYPES
  doctor     Doctor?
  nurse      Nurse?
  pharmacist Pharmacist?
  employee   Employee?
  patient    Patient?

  // OTHER RELATIONS
  medicalRecords           MedicalRecord[]    @relation("MedicalRecordCreator")
  commissionPayouts        CommissionPayout[] @relation("CommissionPayoutCreator")
  commissionSetupsCreated  CommissionSetup[]  @relation("CommissionSetupCreator")
  insuranceClaimsProcessed InsuranceClaim[]   @relation("ClaimProcessedBy")
  refundsProcessed         Refund[]           @relation("RefundProcessedBy")
  dutyRostersCreated       DutyRoster[]       @relation("DutyRosterCreator")
  dutyAssignments          DutyAssignment[]
  housekeepingVerified     HousekeepingTask[] @relation("HousekeepingVerifier")
  bloodRequestsRequested   BloodRequest[]     @relation("BloodRequestRequester")
  auditLogs                AuditLog[]
  attendances              StaffAttendance[]
  labResults               LabResult[]        @relation("user_lab_results")
  pharmacySales            PharmacySale[]     @relation("user_pharmacy_sales")
  appointmentsCreated      Appointment[]      @relation("UserCreatedAppointments")

  @@index([role])
}

//==========================================================================================================================

//location tracker by mukul
model Beacon {
  id          Int                @id @default(autoincrement())  // üîÅ changed from String to Int
  beaconCode  String             @unique
  zoneName    String
  building    String?
  floor       String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // One beacon ‚Üí Many location updates
  locations   LocationTracking[]
}


model LocationTracking {
  id          Int      @id @default(autoincrement())   // üîÅ changed from String to Int
  userId      Int      @unique                        // üîÅ Int type (match User.id) + unique (for one-to-one)
  beaconId    Int
  lastSeen    DateTime @default(now())
  isActive    Boolean  @default(true)

  // Many locations ‚Üí One user
  user        User     @relation(fields: [userId], references: [id])

  // Many locations ‚Üí One beacon
  beacon      Beacon   @relation(fields: [beaconId], references: [id])
}



//=============================================================================
model AuditLog {
  id          Int      @id @default(autoincrement())
  entity      String
  entityId    Int?
  action      String
  description String?
  performedBy Int?
  metadata    Json?
  ipAddress   String?
  createdAt   DateTime @default(now())

  performedByUser User? @relation(fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([entity, entityId])
}


//employye//employye
model Employee {
  id             Int        @id @default(autoincrement())
  publicId       String     @unique @default(uuid())
  userId         Int        @unique
  departmentId   Int?
  employeeCode   String     @unique
  role           UserRole
  dateOfBirth    DateTime?
  phone          String     @unique
  gender         Gender     @default(UNKNOWN)
  address        String?
  specialization String?
  qualification  String?
  experience     String?
  joinDate       DateTime
  isActive       Boolean    @default(true)
  deletedAt      DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department  Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  // attendances StaffAttendance[]

  @@index([departmentId])
  @@index([publicId])
}


// üõ†Ô∏è Department Model (for relational data)
model Department {
  id          Int            @id @default(autoincrement())
  publicId    String         @unique @default(uuid())
  name        String
  code        String?        @unique
  description String?
  type        DepartmentType @default(CLINICAL)
  isActive    Boolean        @default(true)
  deletedAt   DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // RELATIONS
  employees              Employee[]
  doctors                Doctor[]                @relation("DoctorDepartment")
  nurses                 Nurse[]                 @relation("NurseDepartment")
  pharmacists            Pharmacist[]            @relation("PharmacistDepartment") // ‚úÖ FIXED
  rooms                  Room[]
  labTemplates           LabTestTemplate[]
  radioTemplates         RadiologyTemplate[]
  expenses               Expense[]
  dutyRosters            DutyRoster[]
  appointments           Appointment[]
  commissionSetups       CommissionSetup[]
  commissionTransactions CommissionTransaction[]
  departmentRevenues     DepartmentRevenue[]

  @@index([name])
}



// Role Model for DutyAssignment
model Role {
  id          Int      @id @default(autoincrement())
  publicId    String   @unique @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dutyAssignments DutyAssignment[]

  @@index([name])
  @@map("roles")
}

model RadiologyOrder {
  id          Int    @id @default(autoincrement())
  orderId     String @unique @default(uuid())
  patientName String
  studyType   String
  orderedBy   String

  orderedDate DateTime
  status      RadiologyStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// --------------------
/// People: Patients & Staff
/// --------------------

model Patient {
  id       Int    @id @default(autoincrement())
  publicId String @unique @default(uuid())
  userId   Int?   @unique // Relation to User model
  user     User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  mrn               String?        @unique // Medical Record Number
  fatherName        String
  nationalId        String?        //mukul add this line
  bloodGroup        BloodType
  allergies         String?
  medicalHistory    String?
  currentTreatment  String?
  height            Float?
  weight            Float?
  // üö® Emergency & Insurance
  emergencyName     String?
  emergencyPhone    String?
  insuranceInfo     Json?
  insuranceProvider String?
  policyNumber      String?
  // üìã Status & Audit
  status            PatientStatus? @default(OPD)
  isActive          Boolean        @default(true)
  deletedAt         DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // üîó Relations with other modules
  appointments      Appointment[]
  medicalRecords    MedicalRecord[]
  invoices          Invoice[]
  prescriptions     Prescription[]
  admissions        Admission[]
  labRequests       LabRequest[]
  radiologyRequests RadiologyRequest[]
  procedures        Procedure[]
  medicationLogs    MedicationLog[]
  nurseNotes        NurseNote[]
  bloodRequests     BloodRequest[]
  vitals            Vital[]
  followUps         FollowUp[]
  insuranceClaims   InsuranceClaim[]
  refunds           Refund[]

  // Indexes for faster query
  @@index([publicId])
  @@index([status])
  @@index([nationalId])
}

// ‚úÖ UPDATED: Common fields (name, contact) removed.
// userId made mandatory.
model Doctor {
  id             Int       @id @default(autoincrement())
  publicId       String    @unique @default(uuid())
  userId         Int       @unique           // One-to-One: MANDATORY (Each doctor must have a User)
  doctorCode     String    @unique
  referralCodeId Int?
  departmentId   Int?                         // üîó Foreign key to Department
  speciality     String?
  qualifications String?
  isActive       Boolean   @default(true)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // üîó Relations
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  department             Department?             @relation("DoctorDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  appointments           Appointment[]
  prescriptions          Prescription[]
  labRequests            LabRequest[]            @relation("DoctorLabRequests")
  radiologyRequests      RadiologyRequest[]
  commissions            CommissionSetup[]
  referralCodes          ReferralCode[]
  earnings               DoctorEarning[]
  commissionTransactions CommissionTransaction[]
  proceduresPerformed    Procedure[]
  procedureTeams         ProcedureTeam[]
  recordedVitals         Vital[]
  admissions             Admission[]
  followUps              FollowUp[]              @relation("DoctorFollowUps")
  bloodRequests          BloodRequest[]

  @@index([doctorCode])
  @@index([publicId])
  @@index([departmentId])   // ‚úÖ Helpful for filtering doctors by department
}

// ‚úÖ UPDATED: Common fields (name, contact) removed.
// userId made mandatory.
model Nurse {
  id           Int        @id @default(autoincrement())
  publicId     String     @unique @default(uuid())
  userId       Int        @unique  // One-to-One: MANDATORY
  departmentId Int?                   // üîó Foreign key to Department
  ward         String?                // Nurse-specific
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // üîó Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department  Department? @relation("NurseDepartment", fields: [departmentId], references: [id], onDelete: SetNull)

  medicationLogs MedicationLog[]
  nurseNotes     NurseNote[]

  @@index([departmentId])
}



// ‚úÖ UPDATED: Common fields (name) removed.
// userId made mandatory.
model Pharmacist {
  id           Int       @id @default(autoincrement())
  publicId     String    @unique @default(uuid())
  userId       Int       @unique // One-to-One: MANDATORY
  departmentId Int?
  licenseNo    String?
  specialization String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // üîó Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department  Department? @relation("PharmacistDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  sales       PharmacySale[] @relation("PharmacistSales")

  @@index([departmentId])
}


/// --------------------
/// Staff Attendance
/// --------------------
model StaffAttendance {
  id           String           @id @default(uuid())
  staffId      Int
  date         DateTime
  shiftType    ShiftType
  status       AttendanceStatus @default(PRESENT)
  checkInTime  DateTime?
  checkOutTime DateTime?
  remarks      String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  staff             User               @relation(fields: [staffId], references: [id], onDelete: Cascade)
  housekeepingTasks HousekeepingTask[]

  @@index([staffId, date])
}

/// --------------------
/// Facility (rooms / beds / admission)
/// --------------------
model Room {
  id           Int      @id @default(autoincrement())
  publicId     String   @unique @default(uuid())
  departmentId Int?
  name         String
  floor        String?
  type         String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  beds       Bed[]
}

model Bed {
  id         Int      @id @default(autoincrement())
  roomId     Int
  bedNumber  String
  isOccupied Boolean  @default(false)
  createdAt  DateTime @default(now())

  room       Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  admissions Admission[]
}

model Admission {
  id              String          @id @default(uuid())
  publicId        String          @unique @default(uuid())
  patientId       Int
  doctorId        Int?
  bedId           Int?
  admissionDate   DateTime        @default(now())
  admissionReason String?
  status          AdmissionStatus @default(ADMITTED)
  dischargedAt    DateTime?
  isActive        Boolean         @default(true)
  deletedAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor   Doctor?   @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  bed      Bed?      @relation(fields: [bedId], references: [id], onDelete: SetNull)
  invoices Invoice[]

  @@index([publicId])
}

/// --------------------
/// Appointments & Medical Records
/// --------------------     
model Appointment {
  id                Int               @id @default(autoincrement())
  publicId          String            @unique @default(uuid())
  appointmentNumber String?           @unique  
  patientId         Int
  doctorId          Int?
  departmentId      Int?
  referralCodeId    Int?
  scheduledAt       DateTime
  durationMins      Int?              @default(30)
  status            AppointmentStatus @default(SCHEDULED)
  reason            String?
  notes             String?
  createdById       Int?
  checkedInAt       DateTime?
  consultedAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  isDeleted         Boolean           @default(false)
  isActive          Boolean           @default(true)
  deletedAt         DateTime?

  // üîó Relations
  patient      Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor       Doctor?       @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  department   Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  referralCode ReferralCode? @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  createdBy    User?         @relation("UserCreatedAppointments", fields: [createdById], references: [id], onDelete: SetNull)

  prescriptions     Prescription[]     @relation("AppointmentPrescriptions")
  invoices          Invoice[]
  labRequests       LabRequest[]
  radiologyRequests RadiologyRequest[]
  followUps         FollowUp[]

  @@index([patientId, scheduledAt])
  @@index([doctorId, status])
  @@index([publicId])
}

model MedicalRecord {
  id          Int      @id @default(autoincrement())
  patientId   Int
  title       String?
  description String?
  attachments Json?
  createdAt   DateTime @default(now())
  createdById Int?
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  createdBy   User?    @relation("MedicalRecordCreator", fields: [createdById], references: [id], onDelete: SetNull)
}

/// Follow-up model
model FollowUp {
  id            String          @id @default(uuid())
  patientId     Int
  appointmentId Int?
  doctorId      Int?
  followUpDate  DateTime
  purpose       FollowUpPurpose
  notes         String?
  feedback      String?
  status        FollowUpStatus  @default(SCHEDULED)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  doctor      Doctor?      @relation("DoctorFollowUps", fields: [doctorId], references: [id], onDelete: SetNull)

  @@index([patientId, followUpDate])
  @@index([doctorId, status])
}

/// --------------------
/// Referral & Commission Config / Transactions
/// --------------------
model ReferralCode {
  id          Int       @id @default(autoincrement())
  publicId    String    @unique @default(uuid())
  doctorId    Int
  code        String    @unique
  description String?
  isAuto      Boolean   @default(true)
  isActive    Boolean   @default(true)
  deletedAt   DateTime?
  validFrom   DateTime?
  validTo     DateTime?
  createdAt   DateTime  @default(now())

  // üîó Relations
  doctor                 Doctor                  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  commissionSetups       CommissionSetup[]
  commissionTransactions CommissionTransaction[]
  appointments           Appointment[]
  pharmacySales          PharmacySale[]
  prescriptions          Prescription[]
  labRequests            LabRequest[]
  radiologyRequests      RadiologyRequest[]
  procedures             Procedure[]
  bloodRequests          BloodRequest[]

  @@index([doctorId])
  @@index([code])
}

model CommissionSetup {
  id             Int            @id @default(autoincrement())
  createdById    Int?
  doctorId       Int?
  departmentId   Int?
  referralCodeId Int?
  source         SourceType
  commissionType CommissionType @default(PERCENTAGE)
  value          Decimal        @default("0.00") @db.Decimal(14, 2)
  description    String?
  isActive       Boolean        @default(true)
  validFrom      DateTime?
  validTo        DateTime?
  createdAt      DateTime       @default(now())

  createdBy    User?         @relation("CommissionSetupCreator", fields: [createdById], references: [id], onDelete: SetNull)
  doctor       Doctor?       @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  department   Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  referralCode ReferralCode? @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)

  @@index([source, doctorId, departmentId])
  @@index([source, doctorId, departmentId, referralCodeId]) // Added combined index
}

model CommissionTransaction {
  id             Int                   @id @default(autoincrement())
  referralCodeId Int?
  doctorId       Int
  departmentId   Int?
  sourceType     SourceType
  sourceId       Int?
  invoiceId      Int?
  amount         Decimal               @default("0.00") @db.Decimal(14, 2)
  percentage     Decimal?              @db.Decimal(14, 2)
  commissionType CommissionType
  status         CommissionStatus      @default(PENDING)
  notes          String?
  createdAt      DateTime              @default(now())
  paidAt         DateTime?
  referralCode   ReferralCode?         @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  doctor         Doctor                @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  department     Department?           @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  invoice        Invoice?              @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  payoutItem     CommissionPayoutItem?

  @@index([doctorId, status, sourceType, departmentId])
}

model CommissionPayout {
  id           Int                    @id @default(autoincrement())
  payoutNumber String?                @unique
  totalAmount  Decimal                @default("0.00") @db.Decimal(14, 2)
  issuedAt     DateTime?
  createdAt    DateTime               @default(now())
  createdById  Int?
  notes        String?
  createdBy    User?                  @relation("CommissionPayoutCreator", fields: [createdById], references: [id], onDelete: SetNull)
  items        CommissionPayoutItem[]
}

model CommissionPayoutItem {
  id                      Int     @id @default(autoincrement())
  commissionPayoutId      Int
  commissionTransactionId Int     @unique
  amount                  Decimal @default("0.00") @db.Decimal(14, 2)

  commissionPayout      CommissionPayout      @relation(fields: [commissionPayoutId], references: [id], onDelete: Cascade)
  commissionTransaction CommissionTransaction @relation(fields: [commissionTransactionId], references: [id], onDelete: Cascade)
}

model DoctorEarning {
  id           Int        @id @default(autoincrement())
  doctorId     Int
  amount       Decimal    @default("0.00") @db.Decimal(14, 2)
  sourceType   SourceType
  sourceId     Int?
  referralCode String?
  note         String?
  createdAt    DateTime   @default(now())

  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId, sourceType, createdAt])
}

/// --------------------
/// Pharmacy & Medicines
/// --------------------
model Medicine {
   id           Int             @id @default(autoincrement())
  brandName    String
  genericName  String
  strength     String
  stock        Int             @default(0)
  reorderLevel Int             @default(0)
  expiryDate   DateTime?
  manufacturer String?
  batchNumber  String?
  status       MedicineStatus  @default(IN_STOCK)
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // ‚úÖ RELATIONS
  stocks             PharmacyStock[]
  purchaseOrderItems PurchaseOrderItem[]
  pharmacySaleItems  PharmacySaleItem[]
  prescriptionItems  PrescriptionItem[]
  medicationLogs     MedicationLog[]
}

model PharmacyStock {
  id          Int         @id @default(autoincrement())
  medicineId  Int
  batchNumber String?
  expiryDate  DateTime?
  quantity    Int
  costPrice   Decimal     @default("0.00") @db.Decimal(14, 2)
  status      StockStatus @default(IN_STOCK)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // RELATION
  medicine Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
}

model PurchaseOrder {
  id        Int                 @id @default(autoincrement())
  poNumber  String?             @unique
  supplier  String?
  createdAt DateTime            @default(now())
  items     PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              Int     @id @default(autoincrement())
  purchaseOrderId Int
  medicineId      Int
  quantity        Int
  unitPrice       Decimal @default("0.00") @db.Decimal(14, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  medicine      Medicine      @relation(fields: [medicineId], references: [id], onDelete: Cascade)
}

model PharmacySale {
  id             Int           @id @default(autoincrement())
  publicId       String        @unique @default(uuid())
  saleNumber     String?       @unique
  prescriptionId Int?          @unique
  pharmacistId   Int?
  totalAmount    Decimal       @default("0.00") @db.Decimal(14, 2)
  paymentMode    PaymentMode
  paymentStatus  PaymentStatus @default(PENDING)
  referralCodeId Int?
  isActive       Boolean       @default(true)
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())

  prescription Prescription?      @relation(fields: [prescriptionId], references: [id])
  pharmacist   Pharmacist?        @relation("PharmacistSales", fields: [pharmacistId], references: [id], onDelete: SetNull)
  referralCode ReferralCode?      @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  processedBy  User?              @relation("user_pharmacy_sales", fields: [pharmacistId], references: [id], onDelete: SetNull, map: "PharmacySale_ProcessedBy_fkey")
  items        PharmacySaleItem[]
  invoices     Invoice[]

  @@index([referralCodeId, paymentStatus])
  @@index([publicId])
}

model PharmacySaleItem {
  id             Int     @id @default(autoincrement())
  pharmacySaleId Int
  medicineId     Int
  quantity       Int
  unitPrice      Decimal @default("0.00") @db.Decimal(14, 2)
  totalPrice     Decimal @default("0.00") @db.Decimal(14, 2)

  pharmacySale PharmacySale @relation(fields: [pharmacySaleId], references: [id], onDelete: Cascade)
  medicine     Medicine     @relation(fields: [medicineId], references: [id], onDelete: Cascade)
}

// FIX: Missing model definition for prescription items
model PrescriptionItem {
  id             Int     @id @default(autoincrement())
  prescriptionId Int
  medicineId     Int
  dosage         String? // e.g., '10mg'
  quantity       Int // Total quantity to dispense for the course
  durationDays   Int? // Duration for the course (e.g., 7 days)
  instructions   String? // e.g., 'Twice a day after meal'

  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medicine     Medicine     @relation(fields: [medicineId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
  @@index([medicineId])
}

model Prescription {
  id                 Int                @id @default(autoincrement())
  publicId           String             @unique @default(uuid())
  prescriptionNumber String?            @unique
  patientId          Int
  doctorId           Int?
  issuedAt           DateTime           @default(now())
  notes              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  referralCodeId     Int?
  isActive           Boolean            @default(true)
  deletedAt          DateTime?
  patient            Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor             Doctor?            @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  referralCode       ReferralCode?      @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  items              PrescriptionItem[] // FIXED: Now links to the defined model
  pharmacySale       PharmacySale?
  appointments       Appointment[]      @relation("AppointmentPrescriptions")

  @@index([publicId])
}

/// --------------------
/// Lab & Radiology
/// --------------------
model LabTestTemplate {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  name         String
  departmentId Int?
  price        Decimal  @default("0.00") @db.Decimal(14, 2)
  createdAt    DateTime @default(now())

  department Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  requests   LabRequest[]
}

model LabRequest {
  id             Int           @id @default(autoincrement())
  requestNumber  String?       @unique
  patientId      Int
  doctorId       Int?
  appointmentId  Int?
  templateId     Int?
  referralCodeId Int?
  status         TestStatus    @default(REQUESTED)
  requestedAt    DateTime      @default(now())
  completedAt    DateTime?
  resultFileUrl  String?
  resultSummary  String?
  price          Decimal       @default("0.00") @db.Decimal(14, 2)
  paymentStatus  PaymentStatus @default(PENDING)
  isActive       Boolean       @default(true)
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())

  patient      Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor       Doctor?          @relation("DoctorLabRequests", fields: [doctorId], references: [id], onDelete: SetNull)
  appointment  Appointment?     @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  template     LabTestTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  referralCode ReferralCode?    @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  invoices     Invoice[]

  result LabResult?

  @@index([referralCodeId, status])
}

// LabResult model
model LabResult {
  id            Int          @id @default(autoincrement())
  publicId      String       @unique @default(uuid())
  labRequestId  Int          @unique
  resultantId   Int?
  testName      String?
  resultSummary String?      @db.Text
  resultFileUrl String?
  status        ResultStatus @default(NOT_REPORTED)
  resultedAt    DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  labRequest LabRequest @relation(fields: [labRequestId], references: [id], onDelete: Cascade)
  resultant  User?      @relation("user_lab_results", fields: [resultantId], references: [id], onDelete: SetNull)

  @@index([resultantId])
  @@map("lab_results")
}

model RadiologyTemplate {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  name         String
  departmentId Int?
  price        Decimal  @default("0.00") @db.Decimal(14, 2)
  createdAt    DateTime @default(now())

  department Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  requests   RadiologyRequest[]
}

model RadiologyRequest {
  id             Int           @id @default(autoincrement())
  requestNumber  String?       @unique
  patientId      Int
  doctorId       Int?
  appointmentId  Int?
  templateId     Int?
  referralCodeId Int?
  status         TestStatus    @default(REQUESTED)
  requestedAt    DateTime      @default(now())
  completedAt    DateTime?
  reportUrl      String?
  findings       String?
  price          Decimal       @default("0.00") @db.Decimal(14, 2)
  paymentStatus  PaymentStatus @default(PENDING)
  isActive       Boolean       @default(true)
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())

  patient      Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor       Doctor?            @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  appointment  Appointment?       @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  template     RadiologyTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  referralCode ReferralCode?      @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  invoices     Invoice[]

  @@index([referralCodeId, status])
}

/// --------------------
/// Procedure (replaces Surgery module)
/// --------------------
model Procedure {
  id              Int       @id @default(autoincrement())
  publicId        String    @unique @default(uuid())
  procedureNumber String?   @unique
  patientId       Int
  performedById   Int?
  procedureType   String?
  scheduledAt     DateTime?
  status          String?
  referralCodeId  Int?
  notes           String?
  operatingRoom   String?
  isActive        Boolean   @default(true)
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  patient      Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  performedBy  Doctor?         @relation(fields: [performedById], references: [id], onDelete: SetNull)
  referralCode ReferralCode?   @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)
  invoices     Invoice[]
  team         ProcedureTeam[]

  @@index([referralCodeId, scheduledAt])
  @@index([publicId])
}

/// ProcedureTeam: members involved (mapped to Doctor)
model ProcedureTeam {
  id          Int      @id @default(autoincrement())
  procedureId Int
  memberId    Int // Doctor.id
  memberRole  String?
  createdAt   DateTime @default(now())

  procedure Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  doctor    Doctor    @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

/// --------------------
/// Billing: Invoice / Payment (updated: procedure references)
/// --------------------
model Invoice {
  id                 Int           @id @default(autoincrement())
  publicId           String        @unique @default(uuid())
  invoiceNumber      String        @unique
  invoiceType        InvoiceType
  appointmentId      Int?
  admissionId        String?
  pharmacySaleId     Int?
  labRequestId       Int?
  radiologyRequestId Int?
  procedureId        Int?
  patientId          Int
  totalAmount        Decimal       @default("0.00") @db.Decimal(14, 2)
  paidAmount         Decimal       @default("0.00") @db.Decimal(14, 2)
  paymentMode        PaymentMode?
  paymentStatus      PaymentStatus @default(PENDING)
  issuedAt           DateTime      @default(now())
  dueAt              DateTime?
  isActive           Boolean       @default(true)
  deletedAt          DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment      Appointment?      @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  admission        Admission?        @relation(fields: [admissionId], references: [id], onDelete: SetNull)
  pharmacySale     PharmacySale?     @relation(fields: [pharmacySaleId], references: [id], onDelete: SetNull)
  labRequest       LabRequest?       @relation(fields: [labRequestId], references: [id], onDelete: SetNull)
  radiologyRequest RadiologyRequest? @relation(fields: [radiologyRequestId], references: [id], onDelete: SetNull)
  procedure        Procedure?        @relation(fields: [procedureId], references: [id], onDelete: SetNull)

  payments               Payment[]
  invoiceItems           InvoiceItem[]
  commissionTransactions CommissionTransaction[]
  insuranceClaims        InsuranceClaim[]
  refunds                Refund[]

  @@index([patientId, paymentStatus])
  @@index([publicId])
}

model InvoiceItem {
  id          Int     @id @default(autoincrement())
  invoiceId   Int
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @default("0.00") @db.Decimal(14, 2)
  total       Decimal @default("0.00") @db.Decimal(14, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Payment {
  id          Int           @id @default(autoincrement())
  invoiceId   Int
  amount      Decimal       @default("0.00") @db.Decimal(14, 2)
  paymentMode PaymentMode
  paymentRef  String?
  paidAt      DateTime      @default(now())
  status      PaymentStatus @default(PAID)
  createdAt   DateTime      @default(now())

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  refunds Refund[]

  @@index([invoiceId, status])
}

/// --------------------
/// Insurance Claims Module
/// --------------------
model InsuranceClaim {
  id                String               @id @default(uuid())
  claimNumber       String               @unique
  invoiceId         Int
  patientId         Int
  insuranceProvider String
  policyNumber      String
  claimAmount       Decimal              @default("0.00") @db.Decimal(14, 2)
  approvedAmount    Decimal              @default("0.00") @db.Decimal(14, 2)
  submissionDate    DateTime
  approvalDate      DateTime?
  status            InsuranceClaimStatus @default(SUBMITTED)
  remarks           String?
  documents         Json?
  processedBy       Int?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  invoice         Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  patient         Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  processedByUser User?   @relation("ClaimProcessedBy", fields: [processedBy], references: [id], onDelete: SetNull)

  @@index([patientId, status])
  @@map("insurance_claims")
}

/// --------------------
/// Accounts / Finance helpers
/// --------------------
model Expense {
  id           Int      @id @default(autoincrement())
  title        String
  amount       Decimal  @default("0.00") @db.Decimal(14, 2)
  expenseDate  DateTime
  departmentId Int?
  notes        String?
  createdAt    DateTime @default(now())

  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
}

model DepartmentRevenue {
  id           Int      @id @default(autoincrement())
  departmentId Int
  date         DateTime
  totalAmount  Decimal  @default("0.00") @db.Decimal(14, 2)

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@index([departmentId, date])
}

/// --------------------
/// Nursing / Medication Logs
/// --------------------
model MedicationLog {
  id             Int       @id @default(autoincrement())
  nurseId        Int
  patientId      Int
  medicineId     Int?
  dosage         String?
  administeredAt DateTime  @default(now())
  notes          String?
  nurse          Nurse     @relation(fields: [nurseId], references: [id], onDelete: Cascade)
  patient        Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medicine       Medicine? @relation(fields: [medicineId], references: [id], onDelete: SetNull)
}

model NurseNote {
  id        Int      @id @default(autoincrement())
  nurseId   Int
  patientId Int
  note      String   @db.Text
  createdAt DateTime @default(now())

  nurse   Nurse   @relation(fields: [nurseId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

/// --------------------
/// Attachments, Settings
/// --------------------
model Attachment {
  id        Int      @id @default(autoincrement())
  url       String
  type      String?
  meta      Json?
  createdAt DateTime @default(now())
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  group     String?
  updatedAt DateTime @updatedAt
}

/// --------------------
/// Blood Bank Module
/// --------------------
model BloodDonor {
  id          Int       @id @default(autoincrement())
  donorCode   String?   @unique
  firstName   String
  lastName    String?
  contact     String?
  bloodType   BloodType
  lastDonated DateTime?
  createdAt   DateTime  @default(now())

  inventories BloodInventory[]
}

model BloodInventory {
  id          Int       @id @default(autoincrement())
  publicId    String    @unique @default(uuid())
  donorId     Int?
  bloodType   BloodType
  units       Int       @default(1)
  collectedAt DateTime  @default(now())
  expiryAt    DateTime?
  status      String?
  isActive    Boolean   @default(true)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())

  donor    BloodDonor?    @relation(fields: [donorId], references: [id], onDelete: SetNull)
  requests BloodRequest[]

  @@index([bloodType, status])
  @@index([publicId])
}

model BloodRequest {
  id               Int       @id @default(autoincrement())
  publicId         String    @unique @default(uuid())
  requestNumber    String?   @unique
  inventoryId      Int?
  patientId        Int?
  requestedById    Int?
  doctorId         Int?
  referralCodeId   Int?
  unitsRequested   Int       @default(1)
  unitsIssued      Int?
  issueDate        DateTime?
  status           String    @default("REQUESTED")
  commissionAmount Decimal   @default("0.00") @db.Decimal(14, 2)
  notes            String?
  isActive         Boolean   @default(true)
  deletedAt        DateTime?
  createdAt        DateTime  @default(now())

  inventory    BloodInventory? @relation(fields: [inventoryId], references: [id], onDelete: SetNull)
  patient      Patient?        @relation(fields: [patientId], references: [id], onDelete: SetNull)
  requestedBy  User?           @relation("BloodRequestRequester", fields: [requestedById], references: [id], onDelete: SetNull)
  doctor       Doctor?         @relation(fields: [doctorId], references: [id], onDelete: SetNull)
  referralCode ReferralCode?   @relation(fields: [referralCodeId], references: [id], onDelete: SetNull)

  @@index([doctorId, referralCodeId, status])
  @@index([publicId])
}

/// --------------------
/// Patient Vitals Module
/// --------------------
model Vital {
  id                     Int      @id @default(autoincrement())
  patientId              Int
  recordedById           Int?
  temperature            Float?
  pulse                  Float?
  bloodPressureSystolic  Float?
  bloodPressureDiastolic Float?
  respiratoryRate        Float?
  spo2                   Float?
  weight                 Float?
  height                 Float?
  bmi                    Float?
  remarks                String?
  recordedAt             DateTime @default(now())
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  patient    Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recordedBy Doctor? @relation(fields: [recordedById], references: [id], onDelete: SetNull)

  @@index([patientId, recordedAt])
  @@map("vitals")
}

/// --------------------
/// Refunds Module
/// --------------------
model Refund {
  id             String       @id @default(uuid())
  invoiceId      Int
  paymentId      Int
  patientId      Int
  refundAmount   Decimal      @default("0.00") @db.Decimal(14, 2)
  refundMode     RefundMode
  transactionRef String?
  refundReason   RefundReason
  processedBy    Int?
  refundDate     DateTime
  status         RefundStatus @default(PENDING)
  remarks        String?
  attachment     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  invoice         Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment         Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  patient         Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  processedByUser User?   @relation("RefundProcessedBy", fields: [processedBy], references: [id], onDelete: SetNull)

  @@index([patientId, status, refundDate])
  @@map("refunds")
}

/// --------------------
/// Duty Roster & Housekeeping
/// --------------------
model DutyRoster {
  id           String        @id @default(uuid())
  rosterName   String
  departmentId Int
  startDate    DateTime
  endDate      DateTime
  shiftType    DutyShiftType @default(STRAIGHT)
  isPublished  Boolean       @default(false)
  createdById  Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  department  Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  createdBy   User?            @relation("DutyRosterCreator", fields: [createdById], references: [id], onDelete: SetNull)
  assignments DutyAssignment[]

  @@index([departmentId, startDate, endDate])
}

model DutyAssignment {
  id        String     @id @default(uuid())
  rosterId  String
  staffId   Int
  roleId    Int?
  date      DateTime
  dayOfWeek DayOfWeek
  status    DutyStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  roster DutyRoster @relation(fields: [rosterId], references: [id], onDelete: Cascade)
  staff  User       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  role   Role?      @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@index([rosterId, date])
  @@index([staffId, date])
}

model HousekeepingTask {
  id              String             @id @default(uuid())
  assignedStaffId String
  area            String
  taskType        TaskType
  priority        Priority           @default(MEDIUM)
  scheduledDate   DateTime
  completionDate  DateTime?
  status          HousekeepingStatus @default(PENDING)
  verificationBy  Int?
  remarks         String?
  photoEvidence   Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  assignedStaff StaffAttendance @relation(fields: [assignedStaffId], references: [id], onDelete: Cascade)
  verifiedBy    User?           @relation("HousekeepingVerifier", fields: [verificationBy], references: [id], onDelete: SetNull)

  @@index([assignedStaffId, status])
  @@index([verificationBy, status])
  @@map("housekeeping_tasks")
}

model LabOrder {
  id          Int       @id @default(autoincrement())
  patientName String
  testType    String
  orderedBy   String
  status      LabStatus @default(PENDING)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}
